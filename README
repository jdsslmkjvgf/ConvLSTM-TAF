# Physics-Guided Flood Prediction with ConvLSTM-TAF

A deep learning framework for flood water body prediction using physics-guided attention mechanism.

## Overview

This project implements **ConvLSTM-TAF** (ConvLSTM with Terrain-Attention Fusion), a novel architecture that integrates physical hydrological principles into deep learning for accurate flood prediction.

**Key Innovation**: Triple physics-guided attention mechanism that models:
1，Water body expansion (NDWI)
2，Terrain-driven accumulation (DEM)  
3，Rainfall-triggered flooding (Precipitation)

## Model Architecture

The repository contains two models for comparison:

| Model | Code Name | Description | Parameters |
|-------|-----------|-------------|------------|
| ConvLSTM-TAF | fullmodel | Physics-guided with triple constraints | 121,729 |
| Simplified Baseline | simplified | 3D CNN baseline | 20,305 |

--- ConvLSTM-TAF Architecture

Inputs: NDWI(t-4:t) + DEM + Rain(past+future)
              │
              ▼
      ┌───────────────┐
      │   ConvLSTM    │ ← Spatiotemporal features
      │   (2 layers)  │
      └───────────────┘
              │
        ┌─────┴─────┐
        │           │
        ▼           ▼
   LSTM Feat    DEM Feat
        │           │
        └─────┬─────┘
              │
              ▼
   ┌──────────────────────────┐
   │ Physics-Guided Attention │
   │ ═══════════════════════  │
   │ physics_attn = 1.0 +     │
   │   w₁ · water_attn +      │  (NDWI encoder)
   │   w₂ · terrain_attn +    │  (DEM encoder)
   │   w₃ · rain_attn         │  (Rain encoder)
   └──────────────────────────┘
              │
              ▼
       ┌────────────┐
       │   Decoder  │
       └────────────┘
              │
              ▼
         Prediction


## Performance Results

### Validation Set Performance (Days 816-824)

| Model | F1 Score | IoU | Precision | Recall |
|-------|----------|-----|-----------|--------|
| ConvLSTM-TAF | 0.818±0.015 | 0.692±0.022 | 0.698 | 0.987 |
| Simplified | 0.410±0.270 | 0.276±0.216 | 0.277 | 0.992 |

### Test Set Performance (Day 824)

| Model | F1 Score | IoU | Precision | Recall |
|-------|----------|-----|-----------|--------|
| ConvLSTM-TAF  | 0.828 | 0.707 | 0.715 | 0.983 |
| Simplified | 0.720 | 0.563 | 0.566 | 0.988 |

**Key Finding**: Physics-guided attention provides **40.8% F1 improvement** over the baseline CNN model.

## Requirements

```bash
torch>=1.9.0
numpy>=1.19.0
rasterio>=1.2.0
matplotlib>=3.4.0
```

## Quick Start

### Installation

```bash
conda create -n flood python=3.8
conda activate flood
pip install torch numpy rasterio matplotlib
```

### Training

```python
from seven_model import get_model

# Initialize ConvLSTM-TAF
model = get_model('fullmodel', 
                  input_channels=1,
                  hidden_dim=32,
                  dem_channels=1)

# Forward pass
output = model(x_seq, rain_past, rain_future, dem)
# Inputs:
#   x_seq: (B, 5, 1, H, W) - NDWI time series
#   rain_past: (B, 3) - Historical rainfall
#   rain_future: (B, 1) - Future rainfall
#   dem: (B, 1, H, W) - Elevation model
# Output:
#   (B, 1, H, W) - Flood prediction logits
```

### Data Format

```
data/
├── images/                    # NDWI time series (.tif)
│   ├── 816.tif
│   ├── 817.tif
│   └── ...
├── dem/
│   └── DEM.tif               # Digital Elevation Model
└── GPM/
    └── avg_precip_timeseries.csv  # Daily precipitation
```

## Model Components

### 1. ConvLSTMCell & ConvLSTM
- Captures spatiotemporal dependencies in sequential imagery
- 2-layer architecture with hidden dimension 32

### 2. PhysicsGuidedAttention
- **Core innovation** of ConvLSTM-TAF
- Three learnable attention weights (w₁, w₂, w₃)
- Modulates features based on physical constraints
- Residual connection ensures performance lower bound

### 3. Feature Fusion
- LSTM features (32 channels) + DEM features (8 channels)
- Combined feature dimension: 40 channels
- Decoded to single-channel flood prediction

## Ablation Study

When comparing with extended ablation experiments (7 models):

| Model | F1 Score | Component |
|-------|----------|-----------|
| ConvLSTM-TAF | 0.818 | Full (NDWI+DEM+Rain) |
| ConvLSTM-DEM | 0.803 | NDWI+DEM only |
| ConvLSTM | 0.787 | NDWI only |
| Simplified | 0.410 | 3D CNN baseline |

**Conclusion**: Each component contributes incrementally, with the rain attention providing the final 1.5% boost.

## Citation

```bibtex
@article{convlstm_taf_2026,
  title={ConvLSTM-TAF: Physics-Guided Deep Learning for Flood Prediction},
  author={Lijun Shen},
  year={2026}
}
```

## License

This dataset is released under the Creative Commons Attribution 4.0 International License (CC-BY 4.0). 
Users are free to share and adapt the data, provided appropriate credit is given.

## Contact

- **GitHub**: [github.com/yourusername/flood-prediction](https://github.com/yourusername)
- **Email**: your.email@example.com

---

**Note**: `fullmodel` in code = **ConvLSTM-TAF** in paper (ConvLSTM with Terrain-Attention Fusion)
